openapi: 3.0.3
info:
  title: Claude Ship-It Command API
  description: Workflow orchestration API for automated development pipelines
  version: 1.0.0
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000/api
    description: Local development server
  - url: https://api.claude.ai/commands
    description: Production command server

paths:
  /commands/ship-it:
    post:
      tags:
        - Workflow Orchestration
      summary: Execute development workflow
      description: |
        Orchestrates development workflows by running multiple commands in sequence.
        Automates commit, push, PR creation, and quality gates with progress tracking.

        Supported workflows:
        - **Full**: /review → /test → /commit → /push → /pr (default)
        - **Basic**: /review --quick → /commit → /push
        - **Quick**: /commit → /push
      operationId: executeWorkflow
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowRequest'
            examples:
              full_workflow:
                summary: Full development workflow
                value:
                  workflow: "full"
                  options:
                    failFast: true
                    createBackup: true
              basic_workflow:
                summary: Basic workflow (quick review)
                value:
                  workflow: "basic"
                  options:
                    skipTests: false
              quick_workflow:
                summary: Quick commit and push
                value:
                  workflow: "quick"
                  options:
                    urgentCommit: true
              custom_workflow:
                summary: Custom command sequence
                value:
                  workflow: "custom"
                  commands: ["review --security", "test --coverage", "commit", "push"]
      responses:
        '200':
          description: Workflow completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowResponse'
              examples:
                successful_full:
                  summary: Full workflow completed
                  value:
                    success: true
                    workflow: "full"
                    completed: true
                    steps:
                      - command: "review"
                        status: "completed"
                        duration: 15.2
                        result: "5 issues found, 4 auto-fixed"
                      - command: "test"
                        status: "completed"
                        duration: 8.7
                        result: "156 tests passed"
                      - command: "commit"
                        status: "completed"
                        duration: 3.1
                        result: "Commit a1b2c3d created"
                      - command: "push"
                        status: "completed"
                        duration: 2.4
                        result: "Pushed to origin/feature-branch"
                      - command: "pr"
                        status: "skipped"
                        reason: "PR already exists"
                    totalDuration: 29.4
                    artifactsCreated: ["commit-a1b2c3d", "coverage-report.html"]
                partial_success:
                  summary: Workflow partially completed
                  value:
                    success: false
                    workflow: "full"
                    completed: false
                    failedAt: 2
                    steps:
                      - command: "review"
                        status: "completed"
                        duration: 12.1
                        result: "2 issues found, 2 fixed"
                      - command: "test"
                        status: "failed"
                        duration: 5.3
                        error: "3 tests failed"
                        result: "Test suite failed with 3 failures"
                    totalDuration: 17.4
        '400':
          description: Invalid workflow request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_workflow:
                  summary: Unknown workflow type
                  value:
                    error:
                      code: "INVALID_WORKFLOW"
                      message: "Unknown workflow type: invalid-workflow"
                      details:
                        providedWorkflow: "invalid-workflow"
                        supportedWorkflows: ["full", "basic", "quick", "custom"]
                invalid_commands:
                  summary: Invalid custom commands
                  value:
                    error:
                      code: "INVALID_COMMANDS"
                      message: "Custom workflow contains invalid commands"
                      details:
                        invalidCommands: ["invalid-command"]
                        validCommands: ["review", "test", "commit", "push", "pr"]
        '409':
          description: Workflow execution blocked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowBlockedResponse'
              examples:
                review_blocked:
                  summary: Blocked by critical review issues
                  value:
                    success: false
                    blocked: true
                    reason: "Critical security issues must be resolved"
                    failedCommand: "review"
                    blockingIssues:
                      - type: "security"
                        severity: "critical"
                        description: "SQL injection vulnerability in auth/login.js"
                    progress:
                      completed: 0
                      total: 5
                      currentStep: "review"
        '500':
          description: Workflow execution failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                execution_failure:
                  summary: Command execution failed
                  value:
                    error:
                      code: "WORKFLOW_EXECUTION_FAILED"
                      message: "Command execution failed during workflow"
                      details:
                        failedCommand: "push"
                        commandError: "Permission denied (publickey)"
                        rollbackPerformed: false

  /commands/ship-it/status:
    get:
      tags:
        - Workflow Status
      summary: Get workflow execution status
      description: Check the status of currently running or recent workflow executions
      operationId: getWorkflowStatus
      parameters:
        - name: executionId
          in: query
          description: Specific execution ID to check
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Workflow status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowStatus'
              examples:
                running_workflow:
                  summary: Workflow currently running
                  value:
                    executionId: "ship-it-20240115-103045"
                    status: "running"
                    workflow: "full"
                    currentStep: 3
                    totalSteps: 5
                    currentCommand: "commit"
                    progress:
                      - command: "review"
                        status: "completed"
                        duration: 15.2
                      - command: "test"
                        status: "completed"
                        duration: 8.7
                      - command: "commit"
                        status: "running"
                        startedAt: "2024-01-15T10:32:15Z"
                    estimatedCompletion: "2024-01-15T10:35:00Z"
                completed_workflow:
                  summary: Recently completed workflow
                  value:
                    executionId: "ship-it-20240115-095530"
                    status: "completed"
                    workflow: "basic"
                    currentStep: 3
                    totalSteps: 3
                    completedAt: "2024-01-15T09:58:45Z"
                    totalDuration: 28.3
                    success: true

  /commands/ship-it/workflows:
    get:
      tags:
        - Workflow Management
      summary: List available workflows
      description: Get list of all available workflow types and their command sequences
      operationId: getAvailableWorkflows
      responses:
        '200':
          description: Available workflows retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowsResponse'

  /commands/ship-it/history:
    get:
      tags:
        - Workflow History
      summary: Get workflow execution history
      description: Retrieve history of workflow executions with filtering options
      operationId: getWorkflowHistory
      parameters:
        - name: limit
          in: query
          description: Maximum number of executions to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: workflow
          in: query
          description: Filter by workflow type
          required: false
          schema:
            type: string
            enum: [full, basic, quick, custom]
        - name: status
          in: query
          description: Filter by execution status
          required: false
          schema:
            type: string
            enum: [completed, failed, running, cancelled]
      responses:
        '200':
          description: Workflow history retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowHistory'

  /commands/ship-it/cancel:
    post:
      tags:
        - Workflow Control
      summary: Cancel running workflow
      description: Cancel a currently executing workflow
      operationId: cancelWorkflow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelRequest'
      responses:
        '200':
          description: Workflow cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelResponse'
        '404':
          description: No running workflow found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    WorkflowRequest:
      type: object
      properties:
        workflow:
          type: string
          enum: [full, basic, quick, custom]
          default: full
          description: Type of workflow to execute
        commands:
          type: array
          items:
            type: string
          description: Custom command sequence (when workflow is 'custom')
          example: ["review --security", "test --coverage", "commit", "push"]
        options:
          type: object
          properties:
            failFast:
              type: boolean
              default: true
              description: Stop execution on first command failure
            createBackup:
              type: boolean
              default: false
              description: Create backup before starting workflow
            skipTests:
              type: boolean
              default: false
              description: Skip test execution in workflow
            urgentCommit:
              type: boolean
              default: false
              description: Mark commits as urgent (affects review strictness)
            prTemplate:
              type: string
              description: Custom PR template to use
            notifications:
              type: boolean
              default: true
              description: Enable progress notifications
          additionalProperties: false
        context:
          type: object
          properties:
            branch:
              type: string
              description: Target branch for operations
            environment:
              type: string
              enum: [development, staging, production]
              description: Deployment environment context
            priority:
              type: string
              enum: [low, normal, high, urgent]
              default: normal
              description: Workflow execution priority
          description: Additional context for workflow execution

    WorkflowResponse:
      type: object
      required:
        - success
        - workflow
        - completed
        - steps
      properties:
        success:
          type: boolean
          description: Whether the entire workflow completed successfully
        workflow:
          type: string
          description: Type of workflow executed
        completed:
          type: boolean
          description: Whether workflow finished (successfully or not)
        executionId:
          type: string
          description: Unique identifier for this workflow execution
        failedAt:
          type: integer
          description: Step number where workflow failed (if applicable)
        steps:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowStep'
          description: Details of each workflow step
        totalDuration:
          type: number
          format: float
          description: Total workflow execution time in seconds
        artifactsCreated:
          type: array
          items:
            type: string
          description: Files, commits, or other artifacts created
        recommendations:
          type: array
          items:
            type: string
          description: Suggestions for improving future workflow runs

    WorkflowStep:
      type: object
      required:
        - command
        - status
      properties:
        command:
          type: string
          description: Command that was executed
        status:
          type: string
          enum: [pending, running, completed, failed, skipped, cancelled]
          description: Current status of the step
        duration:
          type: number
          format: float
          description: Step execution time in seconds
        startedAt:
          type: string
          format: date-time
          description: When step execution started
        completedAt:
          type: string
          format: date-time
          description: When step execution finished
        result:
          type: string
          description: Human-readable result summary
        error:
          type: string
          description: Error message if step failed
        output:
          type: string
          description: Command output (if requested)
        artifacts:
          type: array
          items:
            type: string
          description: Artifacts created by this step
        metrics:
          type: object
          properties:
            memoryUsage:
              type: integer
            cpuUsage:
              type: number
              format: float
            exitCode:
              type: integer
          description: Execution metrics for this step

    WorkflowBlockedResponse:
      type: object
      required:
        - success
        - blocked
        - reason
        - failedCommand
      properties:
        success:
          type: boolean
          enum: [false]
        blocked:
          type: boolean
          enum: [true]
        reason:
          type: string
          description: Human-readable reason for blocking
        failedCommand:
          type: string
          description: Command that caused the workflow to be blocked
        blockingIssues:
          type: array
          items:
            $ref: '#/components/schemas/BlockingIssue'
          description: Specific issues that are blocking execution
        progress:
          type: object
          properties:
            completed:
              type: integer
            total:
              type: integer
            currentStep:
              type: string
          description: Progress information at time of blocking
        recommendations:
          type: array
          items:
            type: string
          description: Suggested actions to resolve blocking issues

    BlockingIssue:
      type: object
      required:
        - type
        - severity
        - description
      properties:
        type:
          type: string
          enum: [security, quality, testing, dependency, configuration]
          description: Category of blocking issue
        severity:
          type: string
          enum: [critical, high, medium]
          description: Issue severity level
        description:
          type: string
          description: Detailed description of the issue
        file:
          type: string
          description: File associated with the issue
        line:
          type: integer
          description: Line number (if applicable)
        resolution:
          type: string
          description: Suggested resolution steps

    WorkflowStatus:
      type: object
      required:
        - executionId
        - status
        - workflow
      properties:
        executionId:
          type: string
          description: Unique workflow execution identifier
        status:
          type: string
          enum: [pending, running, completed, failed, cancelled]
          description: Current workflow status
        workflow:
          type: string
          description: Type of workflow being executed
        currentStep:
          type: integer
          description: Current step number (1-based)
        totalSteps:
          type: integer
          description: Total number of steps in workflow
        currentCommand:
          type: string
          description: Currently executing command
        startedAt:
          type: string
          format: date-time
          description: When workflow execution started
        completedAt:
          type: string
          format: date-time
          description: When workflow execution completed
        estimatedCompletion:
          type: string
          format: date-time
          description: Estimated completion time (for running workflows)
        totalDuration:
          type: number
          format: float
          description: Total execution duration in seconds
        success:
          type: boolean
          description: Whether workflow completed successfully
        progress:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowStep'
          description: Progress of individual steps

    WorkflowsResponse:
      type: object
      required:
        - workflows
      properties:
        workflows:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowDefinition'
          description: Available workflow definitions

    WorkflowDefinition:
      type: object
      required:
        - name
        - description
        - commands
      properties:
        name:
          type: string
          description: Workflow name
        description:
          type: string
          description: Human-readable workflow description
        commands:
          type: array
          items:
            type: string
          description: Sequence of commands in workflow
        estimatedDuration:
          type: number
          format: float
          description: Estimated execution time in seconds
        requiresCleanState:
          type: boolean
          description: Whether workflow requires clean git state
        defaultOptions:
          type: object
          description: Default options for this workflow
          additionalProperties: true

    WorkflowHistory:
      type: object
      required:
        - executions
        - total
      properties:
        executions:
          type: array
          items:
            $ref: '#/components/schemas/HistoryEntry'
          description: Historical workflow executions
        total:
          type: integer
          description: Total number of executions (may be larger than returned)
        statistics:
          type: object
          properties:
            averageDuration:
              type: number
              format: float
            successRate:
              type: number
              format: float
            mostCommonWorkflow:
              type: string
            failureReasons:
              type: array
              items:
                type: object
                properties:
                  reason:
                    type: string
                  count:
                    type: integer
          description: Aggregated statistics

    HistoryEntry:
      type: object
      required:
        - executionId
        - workflow
        - status
        - startedAt
      properties:
        executionId:
          type: string
          description: Unique execution identifier
        workflow:
          type: string
          description: Workflow type that was executed
        status:
          type: string
          enum: [completed, failed, cancelled]
          description: Final execution status
        startedAt:
          type: string
          format: date-time
          description: When execution started
        completedAt:
          type: string
          format: date-time
          description: When execution finished
        duration:
          type: number
          format: float
          description: Total execution duration
        success:
          type: boolean
          description: Whether execution was successful
        stepsCompleted:
          type: integer
          description: Number of steps completed
        totalSteps:
          type: integer
          description: Total number of steps in workflow
        failureReason:
          type: string
          description: Reason for failure (if applicable)

    CancelRequest:
      type: object
      properties:
        executionId:
          type: string
          description: Specific execution to cancel (optional, cancels current if not provided)
        force:
          type: boolean
          default: false
          description: Force cancellation even if step is in critical phase
        reason:
          type: string
          description: Reason for cancellation

    CancelResponse:
      type: object
      required:
        - success
        - executionId
      properties:
        success:
          type: boolean
          description: Whether cancellation was successful
        executionId:
          type: string
          description: ID of cancelled execution
        cancelledAt:
          type: string
          format: date-time
          description: When cancellation occurred
        stepsCompleted:
          type: integer
          description: Number of steps completed before cancellation
        currentStep:
          type: string
          description: Step that was running when cancelled
        rollbackPerformed:
          type: boolean
          description: Whether any rollback actions were performed

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Machine-readable error code
            message:
              type: string
              description: Human-readable error message
            details:
              type: object
              description: Additional error context
              additionalProperties: true

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - ApiKeyAuth: []
  - BearerAuth: []

tags:
  - name: Workflow Orchestration
    description: Automated development workflow execution
  - name: Workflow Status
    description: Workflow execution monitoring
  - name: Workflow Management
    description: Workflow configuration and templates
  - name: Workflow History
    description: Historical workflow execution data
  - name: Workflow Control
    description: Workflow execution control operations
