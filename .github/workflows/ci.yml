name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML

    - name: Verify Python environment
      run: |
        echo "Python environment verification:"
        python --version
        python -c "import yaml; print(f'PyYAML version: {yaml.__version__}')"
        echo "✓ Python environment ready"

    - name: Setup Node.js (for markdownlint only)
      uses: actions/setup-node@v5
      with:
        node-version: '20'
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'

    - name: Install Node.js dependencies
      run: |
        npm ci --prefer-offline --no-audit --progress=false

    - name: Make test script executable
      run: chmod +x tests/test.sh

    - name: Run test suite
      run: |
        echo "=== CI Environment Info ==="
        echo "Runner OS: $RUNNER_OS"
        echo "Home: $HOME"
        echo "Temp: $TMPDIR"
        echo "Python: $(python --version)"
        echo "Bash: $(bash --version | head -1)"
        echo "Working Directory: $(pwd)"
        echo "=========================="
        ./tests/test.sh

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          test-results.log
          tests/**/*.log
          /tmp/verify-test-results-*/
        retention-days: 30

  validate-structure:
    name: Validate Repository Structure
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Check required files exist
      run: |
        echo "Checking required files..."
        required_files=(
          "README.md"
          "system-configs/CLAUDE.md"
          "LICENSE"
          "tests/test.sh"
          "system-configs/.claude/commands/plan.md"
          "system-configs/.claude/commands/commit.md"
          "system-configs/.claude/commands/push.md"
          "system-configs/.claude/commands/test.md"
          "system-configs/.claude/commands/prime.md"
          "system-configs/.claude/commands/sync.md"
          "system-configs/.claude/commands/verify.md"
        )

        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ Missing required file: $file"
            exit 1
          else
            echo "✓ Found: $file"
          fi
        done

        echo "All required files present!"

    - name: Check file permissions
      run: |
        if [ ! -x "tests/test.sh" ]; then
          echo "❌ tests/test.sh is not executable"
          exit 1
        fi
        echo "✓ tests/test.sh is executable"

  lint-markdown:
    name: Lint Markdown Files
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install markdownlint
      run: npm ci --prefer-offline --no-audit --progress=false

    - name: Lint markdown files
      uses: DavidAnson/markdownlint-cli2-action@v20
      continue-on-error: true
      with:
        config: '.markdownlint-cli2.jsonc'
        globs: '**/*.md'

  shellcheck-validation:
    name: Shell Script Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Install ShellCheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck

    - name: Run ShellCheck on critical scripts
      run: |
        echo "Running ShellCheck on critical scripts..."

        # Critical scripts that must pass
        critical_scripts=(
          "tests/test.sh"
          "scripts/setup-shellcheck.sh"
          "scripts/validate-system.sh"
          "scripts/validate_yaml.sh"
        )

        exit_code=0

        for script in "${critical_scripts[@]}"; do
          if [ -f "$script" ]; then
            echo "Checking: $script"
            if shellcheck --severity=warning --exclude=SC1091,SC2034,SC2155,SC2250,SC2292,SC2310 "$script"; then
              echo "✅ PASSED: $script"
            else
              echo "❌ FAILED: $script"
              exit_code=1
            fi
          else
            echo "⚠️ Script not found: $script"
          fi
        done

        if [ $exit_code -ne 0 ]; then
          echo "❌ Critical scripts validation failed!"
          exit 1
        else
          echo "✅ All critical scripts passed validation!"
        fi