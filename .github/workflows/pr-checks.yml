name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  test-changes:
    name: Test Changes
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent indefinite hangs

    env:
      CI: true
      NO_COLOR: 1
      TERM: dumb
      TMPDIR: /tmp/pr-test

    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v6
      with:
        fetch-depth: 1  # Standardize with main CI workflow

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.13.5'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3-dev

    - name: Install Python dependencies with version pinning
      run: |
        python -m pip install --upgrade pip>=24.0

        # Install core dependencies
        if [ -f "requirements.txt" ]; then
          echo "Installing core dependencies from requirements.txt..."
          pip install -r requirements.txt
        else
          # Fallback to direct install if requirements.txt doesn't exist
          pip install PyYAML==6.0.2
        fi

        # Install performance script dependencies if needed
        if [ -f "scripts/performance/requirements.txt" ]; then
          echo "Installing performance dependencies..."
          pip install -r scripts/performance/requirements.txt
        fi

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20.18.0'
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'

    - name: Configure npm for retry handling
      run: |
        npm config set registry https://registry.npmjs.org/
        npm config set fetch-retry-mintimeout 20000
        npm config set fetch-retry-maxtimeout 120000
        npm config set fetch-retry-factor 2
        npm config set fetch-retries 5
        npm config set fetch-timeout 300000

    - name: Install dependencies with retry logic
      run: |
        for attempt in {1..5}; do
          echo "Attempt $attempt to install dependencies..."
          if npm ci --prefer-offline --no-audit --progress=false; then
            echo "Dependencies installed successfully on attempt $attempt"
            break
          elif [ $attempt -eq 5 ]; then
            echo "All attempts failed. Exiting with error."
            exit 1
          else
            echo "Attempt $attempt failed. Retrying in $((attempt * 10)) seconds..."
            sleep $((attempt * 10))
          fi
        done

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v47

    - name: List changed files
      run: |
        echo "Changed files:"
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo "  - $file"
        done

    - name: Setup test environment
      run: |
        # Create temp directory with proper permissions
        mkdir -p "$TMPDIR"
        chmod 755 "$TMPDIR"

        # Set resource limits for tests
        ulimit -n 2048 || true

        echo "Test environment ready:"
        echo "  TMPDIR: $TMPDIR"
        echo "  Available space:"
        df -h "$TMPDIR"

    - name: Run tests
      run: |
        chmod +x tests/test.sh
        ./tests/test.sh

    - name: Check if sync needed
      if: contains(steps.changed-files.outputs.all_changed_files, 'system-configs/CLAUDE.md') || contains(steps.changed-files.outputs.all_changed_files, 'system-configs/.claude/skills/')
      run: |
        echo "⚠️ Changes detected in configuration files!"
        echo "Remember to run /sync command after merging to update your local configuration."

  skill-validation:
    name: Validate Skills
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Validate skill structure
      run: |
        echo "Validating skill files..."

        skills_dir="system-configs/.claude/skills"

        if [ ! -d "$skills_dir" ]; then
          echo "❌ Skills directory not found: $skills_dir"
          exit 1
        fi

        found_skills=0

        for skill_dir in "$skills_dir"/*/; do
          # Skip if glob didn't match
          [ -d "$skill_dir" ] || continue

          skill_name=$(basename "$skill_dir")

          # Skip hidden directories
          if [[ "$skill_name" == .* ]]; then
            continue
          fi

          skill_file="$skill_dir/SKILL.md"

          if [ ! -f "$skill_file" ]; then
            echo "❌ Missing SKILL.md in $skill_name/"
            exit 1
          fi

          echo "Checking $skill_name/SKILL.md..."
          found_skills=$((found_skills + 1))

          # Check for YAML front-matter
          if ! head -1 "$skill_file" | grep -q "^---"; then
            echo "❌ Missing YAML front-matter (must start with ---) in $skill_name/SKILL.md"
            exit 1
          fi

          # Reference skills (user-invocable: false) and imported skills have different structure
          if grep -q "^user-invocable: false" "$skill_file" || grep -q "^license:" "$skill_file"; then
            echo "✓ $skill_name/SKILL.md (reference/imported skill, front-matter valid)"
            continue
          fi

          # Check for required sections (user-invocable skills only)
          if ! grep -q "^# /" "$skill_file"; then
            echo "❌ Missing skill header starting with '# /' in $skill_name/SKILL.md"
            exit 1
          fi

          if ! grep -q "^## Usage" "$skill_file"; then
            echo "❌ Missing Usage section in $skill_name/SKILL.md"
            exit 1
          fi

          if ! grep -q "^## Description" "$skill_file"; then
            echo "❌ Missing Description section in $skill_name/SKILL.md"
            exit 1
          fi

          echo "✓ $skill_name/SKILL.md structure is valid"
        done

        if [ "$found_skills" -eq 0 ]; then
          echo "❌ No skills found in $skills_dir"
          exit 1
        fi

        echo "All $found_skills skill files are properly structured!"

  security-check:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Check for sensitive data
      run: |
        echo "Scanning for sensitive data..."

        # Check for common patterns of sensitive data
        patterns=(
          "password.*=.*['\"].*['\"]"
          "api[_-]?key.*=.*['\"].*['\"]"
          "secret.*=.*['\"].*['\"]"
          "token.*=.*['\"].*['\"]"
          "private[_-]?key"
        )

        found_issues=false

        for pattern in "${patterns[@]}"; do
          # Exclude .git, node_modules, .github, scripts, and test directories
          # Also exclude example/sample/test/fake/dummy patterns and command documentation
          if grep -r -i -E "$pattern" . \
            --exclude-dir=.git \
            --exclude-dir=node_modules \
            --exclude-dir=.github \
            --exclude-dir=scripts \
            --exclude-dir=tests \
            --exclude="*.md" \
            --exclude="setup-hooks.sh" | \
            grep -v -E "example|sample|test|fake|dummy|mock|pattern|demonstration"; then
            echo "❌ Found potential sensitive data matching pattern: $pattern"
            found_issues=true
          fi
        done

        if [ "$found_issues" = true ]; then
          echo "Security check failed! Please remove sensitive data."
          exit 1
        fi

        echo "✓ No sensitive data patterns found"
